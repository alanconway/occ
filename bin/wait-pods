#!/bin/sh
# Wait for pods in namespaces $* to be ready.
# Requires at least one READY pod per namespace
set -e

get_ns() {
k get pods -o jsonpath=$'{range .items[*]}{.status.phase}\n{end}' | sort -u
    pods=$(kubectl get pods $*) | grep -v -E "(Running|Completed|Succeeded)")
}
get_all() {
    local unready
    for ns in "$@"; do
        unready="$unready$(kubectl get pods $* | grep -v -E "(Running|Completed|Succeeded|STATUS)")
    done
    DELAY=1
    while 
        echo "Unready pods in $*, waiting..."
        echo $UNREADY
        sleep $DELAY;
        DELAY=5
    done
    echo "All pods in $* are ready"
    kubectl get pods $*
}

if test -z "$*"; then
    get_wait --all-namespaces
else
    for N in "$@"; do get_wait --namespace=$N; done
fi
echo

